services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: postgresql_chat_api
    env_file:
      - .env
    environment:
      # API Settings
      - API_TITLE=PostgreSQL Chat API
      - API_VERSION=1.0.0
      - API_PREFIX=/api/v1
      - DEBUG=false
      - LOG_LEVEL=INFO

      # Security
      - API_KEY=${API_KEY}
      - JWT_SECRET=${JWT_SECRET}

      # PostgreSQL (External)
      - POSTGRESQL_URL=${POSTGRESQL_URL:-}
      - POSTGRESQL_DATABASE=${POSTGRESQL_DATABASE:-}
      - DB_HOST=${DB_HOST:-localhost}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-postgres}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-}

      # MongoDB (External)
      - MONGO_URI=${MONGO_URI:-mongodb://localhost:27017/}
      - MONGO_DB_NAME=${MONGO_DB_NAME:-chat_db}

      # LLM - Gemini
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=gemini-2.0-flash
      - GEMINI_TEMPERATURE=0.3

      # LLM - OpenAI (Optional)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - API_KEY_OPENAI=${API_KEY_OPENAI}
      - LLM_MODEL=${LLM_MODEL:-gpt-4}

      # SQL Settings
      - SQL_TIMEOUT_SECONDS=30
      - SQL_MAX_ROWS=1000

    volumes:
      - exports_data:/app/exports
      - charts_data:/app/charts/generated
      - cache_data:/app/cache

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3300/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    network_mode: "host"  # Use host network to access external databases

volumes:
  exports_data:
    driver: local
  charts_data:
    driver: local
  cache_data:
    driver: local
